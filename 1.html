<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Recruitment Event Timeline</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Duolingo-inspired Color Palette */
    :root {
      --primary-green: #78c800;
      --dark-green: #58a700;
      --light-green-bg: #e5f7d9;
      --text-green: #4c9a00;
      --white: #ffffff;
      --medium-gray-text: #777;
      --dark-gray-text: #333;
      --cancel-hover-bg: #e0e0e0;
    }
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; background: #f7f7f7; }
    .timer-container { width: 100%; background: linear-gradient(90deg, var(--primary-green) 0%, var(--dark-green) 100%); color: var(--white); padding: 28px 0 16px 0; display: flex; flex-direction: column; align-items: center; box-shadow: 0 2px 12px 0 rgba(88,167,0,0.15); margin-bottom: 8px; }
    #big-timer { font-size: 2.1rem; font-weight: bold; text-shadow: 0 1px 4px rgba(0,0,0,0.2); letter-spacing: 1.4px; margin-bottom: 0px; font-family: 'Segoe UI Mono', monospace; text-align: center; }
    #ist-label { font-size: 1.15rem; margin-top: 0px; color: var(--light-green-bg); letter-spacing: 2px; opacity: 0.9; }
    h1 { text-align: center; margin: 18px 0 10px 0; color: var(--dark-gray-text); letter-spacing: 2px; font-size: 2.1rem; }
    .timeline-container { position: relative; max-width: 800px; margin: 16px auto 0 auto; padding: 24px 0; }
    .timeline { position: relative; margin: 0 32px; padding-left: 38px; border-left: 4px solid var(--primary-green); }
    .timeline-event { position: relative; margin-bottom: 22px; background: var(--white); border-radius: 12px; box-shadow: 0 2px 8px 0 rgba(0,0,0,0.06); padding: 14px 28px 14px 56px; transition: box-shadow 0.2s, transform 0.2s; }
    .timeline-event:hover { box-shadow: 0 6px 18px 0 rgba(88,167,0,0.15); transform: translateY(-2px); }
    .timeline-dot { content: ""; position: absolute; left: -46px; top: 18px; width: 24px; height: 24px; background: var(--white); border-radius: 50%; z-index: 2; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 0 6px var(--light-green-bg), 0 2px 10px 0 rgba(0,0,0,0.2); }
    .timeline-dot-inner { width: 16px; height: 16px; background: linear-gradient(135deg,var(--primary-green),var(--dark-green) 80%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 4px 0 rgba(0,0,0,0.2); font-size: 1.18rem; color: var(--white); position: relative; }
    .timeline-event.past .timeline-dot-inner { background: linear-gradient(135deg,#e0e0e0,#bdbdbd 80%); color: #aaa; }
    .timeline-event.past { opacity: 0.75; filter: grayscale(40%); }
    .event-date { font-size: 0.9rem; font-weight: bold; color: var(--text-green); display: block; margin-bottom: 4px; }
    .event-title { font-size: 1.1rem; font-weight: 500; color: var(--dark-gray-text); margin-bottom: 6px; display: block; }
    .details-line { display: flex; align-items: baseline; gap: 12px; flex-wrap: wrap; }
    .event-time, .event-duration, .event-location { font-size: 0.95rem; color: var(--medium-gray-text); }
    .timeline-actions { position: absolute; right: 18px; top: 14px; display: flex; gap: 8px; }
    .action-btn { background: #f1f1f1; color: var(--text-green); border: 1px solid #ddd; border-radius: 4px; padding: 2px 10px; font-size: 0.92rem; cursor: pointer; transition: all 0.2s; }
    .action-btn:hover { background: var(--dark-green); border-color: var(--dark-green); color: var(--white); }
    #addEventBtn { display: block; margin: 0 auto 30px auto; padding: 12px 28px; font-size: 1.04rem; background: linear-gradient(135deg, var(--primary-green) 30%, var(--dark-green) 100%); color: var(--white); border: none; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 2px 10px 0 rgba(0,0,0,0.1); transition: all 0.2s; }
    #addEventBtn:hover { background: linear-gradient(135deg, var(--dark-green) 40%, var(--primary-green) 100%); box-shadow: 0 8px 24px 0 rgba(88,167,0,0.22); }
    .modal-bg { display: none; position: fixed; z-index: 99; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(44,62,80,0.14); align-items: center; justify-content: center; }
    .modal { background: var(--white); border-radius: 10px; box-shadow: 0 6px 40px rgba(0,0,0,0.15); padding: 34px 30px 28px 30px; min-width: 320px; max-width: 94vw; position: relative; }
    .modal h2 { text-align: center; font-size: 1.2rem; margin: 0 0 18px 0; color: var(--text-green); }
    .modal label { display: block; margin: 10px 0 2px 0; font-size: 1rem; color: #47627b; }
    .modal input { width: 100%; padding: 7px 8px; border: 1px solid #bbb; border-radius: 5px; margin-bottom: 10px; font-size: 1rem; background: #f9fafb; box-sizing: border-box; }
    .modal .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 12px; }
    .modal .modal-btn { padding: 7px 18px; border: none; border-radius: 5px; font-size: 0.98rem; cursor: pointer; font-weight: 500; transition: all 0.2s; }
    .modal .modal-btn.confirm { background: linear-gradient(135deg, var(--primary-green) 30%, var(--dark-green) 100%); color: var(--white); }
    .modal .modal-btn.confirm:hover { background: linear-gradient(135deg, var(--dark-green) 40%, var(--primary-green) 100%); }
    .modal .modal-btn.cancel { background: #f4f4f4; color: var(--dark-gray-text); }
    .modal .modal-btn.cancel:hover { background: var(--cancel-hover-bg); color: var(--dark-gray-text); }
  </style>
</head>
<body>
  <div class="timer-container"> <div id="big-timer"></div> <div id="ist-label">INDIAN STANDARD TIME</div> </div>
  <h1>Recruitment Event Timeline</h1>
  <button id="addEventBtn">+ Add Event</button>
  <div class="timeline-container"> <div class="timeline" id="timeline"></div> </div>
  <div class="modal-bg" id="eventModalBg"> <div class="modal" id="eventModal"> <h2 id="modalTitle"></h2> <form id="eventForm" autocomplete="off"> <input type="hidden" id="originalTitle" /> <label>Date (e.g. JUL 25):</label> <input type="text" id="eventDate" required /> <label>Start Time:</label> <input type="text" id="eventStartTime" placeholder="9:00 AM or NA" /> <label>End Time:</label> <input type="text" id="eventEndTime" placeholder="10:30 AM" /> <label>Title/Company:</label> <input type="text" id="eventTitle" required /> <label>Location/Mode:</label> <input type="text" id="eventLocation" required /> <div class="modal-actions"> <button type="button" class="modal-btn cancel" onclick="closeModal()">Cancel</button> <button type="submit" class="modal-btn confirm">Save</button> </div> </form> </div> </div>
  <div class="modal-bg" id="passcodeModalBg"> <div class="modal"> <h2>Enter Passcode</h2> <form id="passcodeForm" autocomplete="off"> <label>Passcode:</label> <input type="password" id="passcodeInput" required /> <div class="modal-actions"> <button type="button" class="modal-btn cancel" onclick="closePasscodeModal()">Cancel</button> <button type="submit" class="modal-btn confirm">Submit</button> </div> <div id="passcodeError" style="color:var(--dark-green); margin-top:6px; display:none;">Incorrect passcode.</div> </form> </div> </div>

  <script>
    // =======================================================
    // --- CONFIGURATION ---
    // =======================================================
    const SHEET_API_URL = 'https://sheetdb.io/api/v1/jmrpy9m2ypxyf';
    const PASSCODE = "autism100";

    // =======================================================
    // --- GLOBALS ---
    // =======================================================
    let currentEventsCache = []; // Caching to prevent re-fetching constantly
    let pendingAction = null;
    let originalEventDataForEdit = null;
    const MONTHS = { "JAN":0,"FEB":1,"MAR":2,"APR":3,"MAY":4,"JUN":5, "JUL":6,"AUG":7,"SEP":8,"OCT":9,"NOV":10,"DEC":11 };

    // =======================================================
    // --- HELPER & UTILITY FUNCTIONS ---
    // =======================================================
    function getISTDateObj(date = new Date()) { let utc = date.getTime() + (date.getTimezoneOffset() * 60000); return new Date(utc + 19800000); }
    function pad(n) { return n < 10 ? '0' + n : n; }
    function getDayName(d) { return ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][d]; }
    function getMonthName(m) { return ['January','February','March','April','May','June','July','August','September','October','November','December'][m]; }
    
    function formatTimeForDisplay(dateObj) {
      if (!dateObj || isNaN(dateObj)) return '';
      let hour = dateObj.getHours(), min = dateObj.getMinutes(), ap = hour >= 12 ? 'PM' : 'AM';
      hour %= 12; if (hour === 0) hour = 12;
      return `${hour}:${pad(min)} ${ap}`;
    }

    function formatDuration(start, end) {
        if (!start || !end || isNaN(start) || isNaN(end)) return '';
        let diffMs = end.getTime() - start.getTime(); if (diffMs <= 0) return '';
        diffMs /= 60000; const hours = Math.floor(diffMs / 60), mins = Math.round(diffMs % 60);
        const parts = []; if (hours > 0) parts.push(`${hours}h`); if (mins > 0) parts.push(`${mins}m`);
        return parts.join(' ');
    }

    // =======================================================
    // --- DATA HANDLING (FETCHING & SORTING) ---
    // =======================================================
    async function fetchAndCacheEvents() {
        try {
            const response = await fetch(SHEET_API_URL);
            const events = await response.json();
            currentEventsCache = sortEvents(events);
            return currentEventsCache;
        } catch (error) {
            console.error("Could not fetch events from Google Sheet:", error);
            document.getElementById('timeline').innerHTML = `<div style="text-align:center;color:red;">Error loading events. Please check the API URL and your internet connection.</div>`;
            return [];
        }
    }

    function parseEventDateTime(evt) {
        const invalidReturn = { baseDate: null, start: null, end: null, expiry_end: null };
        if (!evt || !evt.date) return invalidReturn;
        const [mon, d] = evt.date.trim().split(" ");
        if (!mon || !MONTHS.hasOwnProperty(mon.toUpperCase())) return invalidReturn;
        let year = getISTDateObj().getFullYear(), m = MONTHS[mon.toUpperCase()], day = parseInt(d, 10);
        if (getISTDateObj().getMonth() === 11 && m === 0) year += 1;
        const baseDate = new Date(year, m, day);

        const parseTime = (t) => {
            if (!t || t.toUpperCase() === "NA" || t.trim() === '') return null;
            const ampm = t.match(/(a\.?m\.?|p\.?m\.?)/i); const num = t.replace(/[^\d:.]/g, ''); if (!num) return null;
            let [hour, min] = [0, 0];
            if (num.includes(':')) [hour, min] = num.split(':').map(Number);
            else if (num.includes('.')) [hour, min] = num.split('.').map(Number);
            else hour = parseInt(num, 10);
            min = min || 0;
            if (ampm) { let ap = ampm[0].toLowerCase().replace(/\./g, ''); if (ap === 'pm' && hour < 12) hour += 12; if (ap === 'am' && hour === 12) hour = 0; }
            return new Date(year, m, day, hour, min);
        };
        const start = parseTime(evt.startTime); const end = parseTime(evt.endTime);
        const expiry_end = end || (start ? new Date(start.getTime() + 3600 * 1000) : baseDate);
        return { baseDate, start, end, expiry_end };
    }

    function sortEvents(events) {
        return events.sort((a, b) => {
            const aInfo = parseEventDateTime(a); const bInfo = parseEventDateTime(b);
            if (!aInfo.baseDate) return 1; if (!bInfo.baseDate) return -1;
            const dateDiff = aInfo.baseDate.getTime() - bInfo.baseDate.getTime();
            if (dateDiff !== 0) return dateDiff;
            const aHasTime = !!aInfo.start, bHasTime = !!bInfo.start;
            if (aHasTime && bHasTime) return aInfo.start.getTime() - bInfo.start.getTime();
            if (aHasTime) return -1; if (bHasTime) return 1; return 0;
        });
    }

    // =======================================================
    // --- UI RENDERING ---
    // =======================================================
    function renderBigTimer() {
        const nowIST = getISTDateObj();
        const day = getDayName(nowIST.getDay()), date = pad(nowIST.getDate()), month = getMonthName(nowIST.getMonth()), year = nowIST.getFullYear();
        let hour = nowIST.getHours(), min = pad(nowIST.getMinutes()), sec = pad(nowIST.getSeconds()), ap = hour >= 12 ? 'PM' : 'AM';
        let hour12 = hour % 12; if (hour12 === 0) hour12 = 12;
        document.getElementById('big-timer').textContent = `${day}, ${date} ${month} ${year}, ${pad(hour12)}:${min}:${sec} ${ap}`;
    }

    async function renderTimeline() {
      const timeline = document.getElementById('timeline');
      timeline.innerHTML = '<div style="text-align:center;color:#777;">Loading events...</div>';
      const events = await fetchAndCacheEvents();
      timeline.innerHTML = '';
      if (!events.length) {
          timeline.innerHTML = '<div style="text-align:center;color:#777;">No events scheduled.</div>';
          return;
      }
      const now = getISTDateObj();
      events.forEach((evt) => {
        const parsed = parseEventDateTime(evt);
        let isPast = parsed.expiry_end ? parsed.expiry_end < now : false;
        let formattedTime;
        if (parsed.start && parsed.end) formattedTime = `${formatTimeForDisplay(parsed.start)} - ${formatTimeForDisplay(parsed.end)}`;
        else if (parsed.start) formattedTime = `Starts: ${formatTimeForDisplay(parsed.start)}`;
        else formattedTime = "Time: NA";
        let formattedDuration = (parsed.start && parsed.end) ? formatDuration(parsed.start, parsed.end) : "";
        const eventDiv = document.createElement('div');
        eventDiv.className = 'timeline-event' + (isPast ? ' past' : '');
        eventDiv.innerHTML = `
          <div class="timeline-dot"><div class="timeline-dot-inner">${isPast ? '<span style="font-size:1.0rem;">✓</span>' : ''}</div></div>
          <span class="event-date">${evt.date}</span>
          <span class="event-title">${evt.title}</span>
          <div class="details-line">
              <span class="event-time">${formattedTime}</span>
              ${formattedDuration ? `<span class="event-duration">(${formattedDuration})</span>` : ''}
          </div>
          <span class="event-location">${evt.location}</span>
          <div class="timeline-actions">
            <button class="action-btn" onclick="requestPasscode('edit', '${btoa(JSON.stringify(evt))}')" title="Edit">✎</button>
            <button class="action-btn" onclick="requestPasscode('delete', '${evt.title}')" title="Delete"></button>
          </div>`;
        timeline.appendChild(eventDiv);
      });
    }

    // =======================================================
    // --- EVENT & API ACTIONS ---
    // =======================================================
    function openModal(isEdit, eventDataForEdit = null) {
        document.getElementById('eventForm').reset();
        document.getElementById('eventModalBg').style.display = 'flex';
        document.getElementById('modalTitle').innerText = isEdit ? 'Edit Event' : 'Add Event';
        
        if (isEdit && eventDataForEdit) {
            originalEventDataForEdit = eventDataForEdit;
            document.getElementById('eventDate').value = eventDataForEdit.date || '';
            document.getElementById('eventStartTime').value = eventDataForEdit.startTime || '';
            document.getElementById('eventEndTime').value = eventDataForEdit.endTime || '';
            document.getElementById('eventTitle').value = eventDataForEdit.title || '';
            document.getElementById('eventLocation').value = eventDataForEdit.location || '';
        } else {
            originalEventDataForEdit = null;
        }
    }

    async function submitFormAction(event) {
        event.preventDefault();
        const formData = {
            date: document.getElementById('eventDate').value.trim(),
            startTime: document.getElementById('eventStartTime').value.trim(),
            endTime: document.getElementById('eventEndTime').value.trim(),
            title: document.getElementById('eventTitle').value.trim(),
            location: document.getElementById('eventLocation').value.trim(),
        };

        const isEdit = !!originalEventDataForEdit;
        const url = isEdit ? `${SHEET_API_URL}/title/${encodeURIComponent(originalEventDataForEdit.title)}` : SHEET_API_URL;
        const method = isEdit ? 'PATCH' : 'POST';

        // Show loading state
        closeModal();
        document.getElementById('timeline').innerHTML = `<div style="text-align:center;color:#777;">Saving...</div>`;

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: [formData] })
            });
            if (!response.ok) throw new Error('Failed to save data.');
            await renderTimeline(); // Refresh from the source
        } catch(error) {
            console.error("Save error:", error);
            alert("Error saving data. Please try again.");
            await renderTimeline(); // Refresh to show original state
        }
    }

    async function deleteEvent(eventTitle) {
      if (!confirm(`Are you sure you want to delete "${eventTitle}"? This is permanent.`)) return;

      document.getElementById('timeline').innerHTML = `<div style="text-align:center;color:#777;">Deleting...</div>`;

      try {
        const response = await fetch(`${SHEET_API_URL}/title/${encodeURIComponent(eventTitle)}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Failed to delete event.');
        await renderTimeline();
      } catch (error) {
        console.error("Delete error:", error);
        alert("Error deleting event. Please try again.");
        await renderTimeline();
      }
    }

    // =======================================================
    // --- PASSCODE & MODAL HANDLING ---
    // =======================================================
    function closeModal() { document.getElementById('eventModalBg').style.display = 'none'; }
    function closePasscodeModal() { document.getElementById('passcodeModalBg').style.display = 'none'; }

    function requestPasscode(action, data) {
        pendingAction = { type: action, data: data };
        document.getElementById('passcodeInput').value = '';
        document.getElementById('passcodeError').style.display = 'none';
        document.getElementById('passcodeModalBg').style.display = 'flex';
    }

    document.getElementById('passcodeForm').onsubmit = async function(e) {
      e.preventDefault();
      if(document.getElementById('passcodeInput').value.trim() === PASSCODE) {
        closePasscodeModal();
        if (pendingAction.type === 'add') {
            openModal(false);
        } else if (pendingAction.type === 'edit') {
            const eventData = JSON.parse(atob(pendingAction.data));
            openModal(true, eventData);
        } else if (pendingAction.type === 'delete') {
            await deleteEvent(pendingAction.data);
        }
      } else {
        document.getElementById('passcodeError').style.display = 'block';
      }
    }
    
    // =======================================================
    // --- INITIALIZATION ---
    // =======================================================
    document.getElementById('addEventBtn').onclick = () => requestPasscode('add', null);
    document.getElementById('eventForm').onsubmit = submitFormAction;
    document.getElementById('eventModalBg').addEventListener('click', (e) => { if(e.target === e.currentTarget) closeModal(); });
    document.getElementById('passcodeModalBg').addEventListener('click', (e) => { if(e.target === e.currentTarget) closePasscodeModal(); });
    document.addEventListener('keydown', (e) => { if(e.key === "Escape") { closeModal(); closePasscodeModal(); }});
    
    function initialize() {
      renderTimeline();
      renderBigTimer();
      setInterval(renderBigTimer, 1000);
      // Auto-deletion is no longer needed; manage events directly in the Google Sheet.
    }
    initialize();
  </script>
</body>
</html>
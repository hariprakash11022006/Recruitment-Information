<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Recruitment Event Timeline</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f2f2f2;
    }
    .timer-container {
      width: 100%;
      background: linear-gradient(90deg, #2b5876 0%, #4e4376 100%);
      color: #fff;
      padding: 28px 0 16px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: 0 2px 12px 0 rgba(44,62,80,0.08);
      margin-bottom: 8px;
    }
    #big-timer {
      font-size: 2.1rem;
      font-weight: bold;
      text-shadow: 0 2px 8px #3333;
      letter-spacing: 1.4px;
      margin-bottom: 0px;
      font-family: 'Segoe UI Mono', monospace;
      text-align: center;
    }
    #ist-label {
      font-size: 1.15rem;
      margin-top: 0px;
      color: #ffecb3;
      letter-spacing: 2px;
    }
    h1 {
      text-align: center;
      margin: 18px 0 10px 0;
      color: #333;
      letter-spacing: 2px;
      font-size: 2.1rem;
    }
    .timeline-container {
      position: relative;
      max-width: 800px;
      margin: 16px auto 0 auto;
      padding: 24px 0;
    }
    .timeline {
      position: relative;
      margin: 0 32px;
      padding-left: 38px;
      border-left: 4px solid #2b5876;
    }
    .timeline-event {
      position: relative;
      margin-bottom: 44px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px 0 rgba(44,62,80,0.08);
      padding: 18px 32px 18px 56px;
      transition: box-shadow 0.2s;
    }
    .timeline-event:hover {
      box-shadow: 0 8px 24px 0 rgba(44,62,80,0.16);
    }
    .timeline-dot {
      content: "";
      position: absolute;
      left: -46px;
      top: 22px;
      width: 24px;
      height: 24px;
      background: #fff;
      border-radius: 50%;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 6px #e0e7ef, 0 2px 10px 0 #2b587655;
    }
    .timeline-dot-inner {
      width: 16px;
      height: 16px;
      background: linear-gradient(135deg,#2b5876,#4e4376 80%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 4px 0 #2b587633;
      font-size: 1.18rem;
      color: #fff;
      position: relative;
    }
    .timeline-event.past .timeline-dot-inner {
      background: linear-gradient(135deg,#e0e0e0,#bdbdbd 80%);
      color: #aaa;
    }
    .timeline-event.past {
      opacity: 0.7;
      filter: grayscale(30%);
    }
    .event-date {
      font-size: 1rem;
      font-weight: bold;
      color: #2b5876;
      margin-bottom: 6px;
      display: block;
    }
    .event-time {
      font-size: 0.99rem;
      color: #47627b;
      margin-bottom: 4px;
      display: block;
    }
    .event-title {
      font-size: 1.08rem;
      font-weight: 500;
      color: #333;
      margin-bottom: 2px;
      letter-spacing: 0.2px;
    }
    .event-location {
      font-size: 0.93rem;
      color: #777;
      font-style: italic;
    }
    .timeline-actions {
      position: absolute;
      right: 18px;
      top: 18px;
      display: flex;
      gap: 8px;
    }
    .action-btn {
      background: #f2f2f2;
      color: #2b5876;
      border: none;
      border-radius: 4px;
      padding: 2px 10px;
      font-size: 0.92rem;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .action-btn:hover {
      background: #d53369;
      color: #fff;
    }
    #addEventBtn {
      display: block;
      margin: 0 auto 30px auto;
      padding: 12px 28px;
      font-size: 1.04rem;
      background: linear-gradient(135deg, #2b5876 30%, #4e4376 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 1px;
      box-shadow: 0 2px 10px 0 rgba(44,62,80,0.14);
      transition: background 0.2s, box-shadow 0.2s;
    }
    #addEventBtn:hover {
      background: linear-gradient(135deg, #d53369 40%, #cbad6d 100%);
      box-shadow: 0 8px 24px 0 rgba(44,62,80,0.22);
      color: #fff;
    }
    /* Modal Styles */
    .modal-bg {
      display: none;
      position: fixed;
      z-index: 99;
      left: 0; top: 0;
      width: 100vw; height: 100vh;
      background: rgba(44,62,80,0.14);
      align-items: center;
      justify-content: center;
    }
    .modal {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 6px 40px rgba(44,62,80,0.22);
      padding: 34px 30px 28px 30px;
      min-width: 320px;
      max-width: 94vw;
      position: relative;
    }
    .modal h2 {
      text-align: center;
      font-size: 1.2rem;
      margin: 0 0 18px 0;
      color: #2b5876;
    }
    .modal label {
      display: block;
      margin: 10px 0 2px 0;
      font-size: 1rem;
      color: #47627b;
    }
    .modal input, .modal select {
      width: 100%;
      padding: 7px 8px;
      border: 1px solid #bbb;
      border-radius: 5px;
      margin-bottom: 10px;
      font-size: 1rem;
      background: #f9fafb;
      box-sizing: border-box;
    }
    .modal input[type="time"] {
      width: auto;
      min-width: 120px;
    }
    .modal .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 12px;
    }
    .modal .modal-btn {
      padding: 7px 18px;
      border: none;
      border-radius: 5px;
      font-size: 0.98rem;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s, color 0.2s;
    }
    .modal .modal-btn.confirm {
      background: linear-gradient(135deg, #2b5876 30%, #4e4376 100%);
      color: #fff;
    }
    .modal .modal-btn.confirm:hover {
      background: linear-gradient(135deg, #d53369 40%, #cbad6d 100%);
      color: #fff;
    }
    .modal .modal-btn.cancel {
      background: #f4f4f4;
      color: #333;
    }
    .modal .modal-btn.cancel:hover {
      background: #d53369;
      color: #fff;
    }
    
    /* ======== NEW: Mobile Responsive Styles ======== */
    @media (max-width: 600px) {
      body {
          -webkit-text-size-adjust: 100%; /* Prevents text zooming */
      }
      .timer-container {
          padding: 16px 8px 12px 8px; /* Adjust padding for mobile */
      }
      #big-timer {
          font-size: 1.25rem;
          letter-spacing: 1px;
          line-height: 1.4; /* Allow text to wrap nicely */
      }
      #ist-label {
          font-size: 0.9rem;
      }
      h1 {
          font-size: 1.5rem; /* Better title hierarchy on mobile */
      }
      .timeline-container {
          padding: 16px 0;
      }
      .timeline {
          margin: 0 16px;
          padding-left: 28px;
          border-left-width: 3px;
      }
      .timeline-dot {
          left: -43px; /* Adjusted for new padding and border */
          top: 18px;
          width: 20px;
          height: 20px;
          box-shadow: 0 0 0 4px #e0e7ef;
      }
      .timeline-dot-inner {
          width: 12px;
          height: 12px;
      }
      .timeline-event {
          padding: 16px; /* Simpler padding */
          padding-left: 24px;
          display: flex;
          flex-direction: column; /* Stack event info vertically */
          align-items: flex-start;
      }
      .timeline-actions {
          position: static; /* No longer absolute */
          align-self: flex-end; /* Pushes buttons to the right */
          margin-top: 12px; /* Space between text and buttons */
      }
      /* Make modals more touch-friendly */
      .modal {
        padding: 24px 20px 20px 20px;
      }
      .modal input, .modal select {
          padding: 12px 10px; /* Bigger tap target */
          font-size: 1rem;
      }
      #addEventBtn {
          padding: 14px 24px;
          font-size: 1.1rem;
          width: calc(100% - 32px);
      }
    }
  </style>
</head>
<body>
  <div class="timer-container">
    <div id="big-timer"></div>
    <div id="ist-label">INDIAN STANDARD TIME</div>
  </div>
  <h1>Recruitment Event Timeline</h1>
  <button id="addEventBtn">+ Add Event</button>
  <div class="timeline-container">
    <div class="timeline" id="timeline"></div>
  </div>

  <!-- Modal for Add/Edit Event -->
  <div class="modal-bg" id="eventModalBg">
    <div class="modal" id="eventModal">
      <h2 id="modalTitle">Add/Edit Event</h2>
      <form id="eventForm" autocomplete="off">
        <input type="hidden" id="eventIndex" />
        <label>Date (e.g. JUL 25, AUG 4):</label>
        <input type="text" id="eventDate" required pattern="^[A-Z]{3} \d{1,2}$" placeholder="JUL 25" />
        <label>Time:</label>
        <input type="text" id="eventTime" placeholder="5.00 p.m to 6.00 p.m or NA" />
        <label>Title/Company:</label>
        <input type="text" id="eventTitle" required placeholder="Goldman Sachs PPT" />
        <label>Location/Mode:</label>
        <input type="text" id="eventLocation" required placeholder="REMOTE or CUIC" />
        <div class="modal-actions">
          <button type="button" class="modal-btn cancel" onclick="closeModal()">Cancel</button>
          <button type="submit" class="modal-btn confirm" id="modalConfirmBtn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Passcode Modal -->
  <div class="modal-bg" id="passcodeModalBg">
    <div class="modal">
      <h2>Enter Passcode</h2>
      <form id="passcodeForm" autocomplete="off">
        <label>Passcode:</label>
        <input type="password" id="passcodeInput" required />
        <div class="modal-actions">
          <button type="button" class="modal-btn cancel" onclick="closePasscodeModal()">Cancel</button>
          <button type="submit" class="modal-btn confirm">Submit</button>
        </div>
        <div id="passcodeError" style="color:#d53369; margin-top:6px; display:none;">Incorrect passcode.</div>
      </form>
    </div>
  </div>

  <script>
    // --- Helper: IST time ---
    function getISTDateObj(date = new Date()) {
      let utc = date.getTime() + (date.getTimezoneOffset() * 60000);
      return new Date(utc + 19800000); // UTC+5.5 hours for IST
    }
    function pad(n) { return n < 10 ? '0' + n : n; }
    function getDayName(d) {
      return ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][d];
    }
    function getMonthName(m) {
      return ['January','February','March','April','May','June','July','August','September','October','November','December'][m];
    }
    function renderBigTimer() {
      const nowIST = getISTDateObj();
      const day = getDayName(nowIST.getDay());
      const date = pad(nowIST.getDate());
      const month = getMonthName(nowIST.getMonth());
      const year = nowIST.getFullYear();
      let hour = nowIST.getHours();
      const min = pad(nowIST.getMinutes());
      const sec = pad(nowIST.getSeconds());
      let ap = hour >= 12 ? 'PM' : 'AM';
      let hour12 = hour % 12;
      if(hour12 === 0) hour12 = 12;
      hour12 = pad(hour12);
      document.getElementById('big-timer').textContent = `${day}, ${date} ${month} ${year}, ${hour12}:${min}:${sec} ${ap}`;
    }

    // --- Event Data ---
    const initialEvents = [
        { date: "JUL 25", time: "5.00 p.m to 6.00 p.m", title: "Goldman Sachs PPT", location: "REMOTE" },
        { date: "JUL 27", time: "10.00 a.m to 11.00 a.m", title: "Goldman Sachs Test", location: "REMOTE" },
        { date: "JUL 27", time: "6:00 p.m", title: "BNY Mellon Test", location: "REMOTE" },
        { date: "JUL 29", time: "6:30 p.m to 9:30 p.m", title: "Appian PPT", location: "REMOTE" },
        { date: "AUG 3", time: "9.00 a.m", title: "Appian Interview", location: "CUIC" },
        { date: "AUG 4", time: "11.00 a.m", title: "Barclays Test", location: "REMOTE" },
        { date: "AUG 4", time: "5.00 p.m", title: "D. E. Shaw Test", location: "CUIC" },
        { date: "AUG 5", time: "9.00 a.m", title: "D. E. Shaw Interview 1", location: "CUIC" },
        { date: "AUG 6", time: "9.00 a.m", title: "D. E. Shaw Interview 2", location: "CUIC" },
        { date: "AUG 6", time: "6.00 p.m", title: "Wells Fargo PPT", location: "REMOTE" },
        { date: "AUG 8", time: "9.00 a.m", title: "Goldman Sachs Interview", location: "CUIC" },
        { date: "AUG 8", time: "5.00 p.m", title: "Wells Fargo Test", location: "CUIC" },
        { date: "AUG 9", time: "5.00 p.m", title: "American Express Test", location: "REMOTE" },
        { date: "AUG 11", time: "9.00 a.m", title: "Wells Fargo Intern-Interviews", location: "CUIC" },
        { date: "AUG 11", time: "5.00 p.m", title: "Western Digital Test", location: "REMOTE" },
        { date: "AUG 12", time: "9.00 a.m", title: "Western Digital PPT & Interview", location: "CUIC" },
        { date: "AUG 12", time: "9.00 a.m", title: "Wells Fargo FTE-Interviews", location: "CUIC" },
        { date: "AUG 13", time: "NA", title: "American Express Interview", location: "REMOTE" },
        { date: "AUG 14", time: "9.00 a.m", title: "Barclays PPT & Interview", location: "CUIC" },
        { date: "AUG 18", time: "9.00 a.m", title: "BNY Mellon Interview", location: "CUIC" }
    ];

    function getEvents() {
      let events;
      try {
        let raw = localStorage.getItem('timelineEvents');
        if (!raw || raw === "null" || raw === "undefined") return sortEvents(initialEvents.slice());
        events = JSON.parse(raw);
        if (!Array.isArray(events)) return sortEvents(initialEvents.slice());
      } catch { return sortEvents(initialEvents.slice()); }
      return events; // Events are sorted when saved.
    }

    function setEvents(events) {
        if (!Array.isArray(events)) return;
        const sortedEvents = sortEvents(events);
        if (sortedEvents.length === 0) {
            localStorage.removeItem('timelineEvents');
        } else {
            localStorage.setItem('timelineEvents', JSON.stringify(sortedEvents));
        }
    }


    // --- Smart Date Parsing ---
    const MONTHS = {
      "JAN":0,"FEB":1,"MAR":2,"APR":3,"MAY":4,"JUN":5,
      "JUL":6,"AUG":7,"SEP":8,"OCT":9,"NOV":10,"DEC":11
    };
    function parseEventDateTime(evt) {
      if (!evt.date) return null;
      let [mon, d] = evt.date.trim().split(" ");
      if (!mon || !MONTHS.hasOwnProperty(mon.toUpperCase())) return null;
      let year = getISTDateObj().getFullYear();
      let m = MONTHS[mon.toUpperCase()];
      let day = parseInt(d, 10);

      // Handle events in the next year (e.g., viewing Dec event in Jan)
      const now = getISTDateObj();
      if (now.getMonth() > m) {
        year += 1;
      }
      
      if (!evt.time || evt.time.trim().toUpperCase() === "NA") {
        let start = new Date(year, m, day, 0, 0, 0);
        let end = new Date(year, m, day, 23, 59, 59, 999);
        return { start, end };
      }

      let times = evt.time.split("to").map(s => s.trim());
      function parseTime(t) {
        if (!t) return null;
        let ampm = t.match(/(a\.?m\.?|p\.?m\.?)/i);
        let num = t.replace(/[^\d:.]/g, '');
        let hour = 0, min = 0;
        if (num.includes(':')) {
          [hour, min] = num.split(':').map(Number);
        } else if (num.includes('.')) {
          [hour, min] = num.split('.').map(Number);
        } else {
          hour = parseInt(num, 10);
        }
        min = min || 0;
        if (ampm) {
          let ap = ampm[0].toLowerCase().replace(/\./g, '');
          if (ap === 'pm' && hour < 12) hour += 12;
          if (ap === 'am' && hour === 12) hour = 0;
        }
        return { hour, min };
      }

      let st = parseTime(times[0]);
      if (st == null) return null;
      let start = new Date(year, m, day, st.hour, st.min);

      let end;
      if (times.length > 1 && times[1]) {
        let et = parseTime(times[1]);
        if (et) {
          end = new Date(year, m, day, et.hour, et.min);
        }
      }
      if (!end) {
        end = new Date(start.getTime() + 60 * 60000); // Default 1 hour duration
      }
      return { start, end };
    }

    function sortEvents(events) {
      return events.slice().sort((a, b) => {
        let adt = parseEventDateTime(a);
        let bdt = parseEventDateTime(b);
        if (!adt) return 1;
        if (!bdt) return -1;
        return adt.start - bdt.start;
      });
    }

    // --- Render Timeline ---
    function renderTimeline() {
      const timeline = document.getElementById('timeline');
      const events = getEvents();
      timeline.innerHTML = '';
      if (!events.length) {
        timeline.innerHTML = '<div style="text-align:center;color:#777;">No events yet. Add one to get started!</div>';
        return;
      }
      const now = getISTDateObj();
      events.forEach((evt, idx) => {
        const parsed = parseEventDateTime(evt);
        let isPast = false;
        if(parsed && parsed.end < now) isPast = true;
        const eventDiv = document.createElement('div');
        eventDiv.className = 'timeline-event' + (isPast ? ' past' : '');
        eventDiv.innerHTML = `
          <div class="timeline-dot">
            <div class="timeline-dot-inner">${isPast?'<span style="font-size:1.0rem;">✓</span>':''}</div>
          </div>
          <span class="event-date">${evt.date}</span>
          <span class="event-time">${evt.time && evt.time.trim() ? evt.time : 'NA'}</span>
          <span class="event-title">${evt.title}</span>
          <span class="event-location">${evt.location}</span>
          <div class="timeline-actions">
            <button class="action-btn" onclick="requestPasscode('edit', ${idx})" title="Edit">✎</button>
            <button class="action-btn" onclick="requestPasscode('delete', ${idx})" title="Delete"></button>
          </div>
        `;
        timeline.appendChild(eventDiv);
      });
    }

    // --- Autodelete Old Events ---
    // **FIXED**: This function now deletes events as soon as they are over.
    function autodeleteOldEvents() {
      let events = getEvents();
      const now = getISTDateObj();
      let changed = false;

      const filteredEvents = events.filter(evt => {
        const parsed = parseEventDateTime(evt);
        if (!parsed) return true; // Keep malformed events to be fixed manually
        // Delete if the event's END time is in the past.
        if (parsed.end.getTime() < now.getTime()) {
          changed = true;
          return false;
        }
        return true;
      });
      if (changed) {
        setEvents(filteredEvents);
        renderTimeline();
      }
    }

    // --- Modal logic ---
    function openModal(isEdit, idx = null) {
      document.getElementById('eventModalBg').style.display = 'flex';
      document.getElementById('eventForm').reset();
      document.getElementById('eventIndex').value = idx !== null ? idx : '';
      document.getElementById('modalTitle').innerText = isEdit ? 'Edit Event' : 'Add Event';
      if (isEdit && idx !== null) {
        const evt = getEvents()[idx];
        document.getElementById('eventDate').value = evt.date;
        document.getElementById('eventTime').value = evt.time;
        document.getElementById('eventTitle').value = evt.title;
        document.getElementById('eventLocation').value = evt.location;
      }
    }
    function closeModal() {
      document.getElementById('eventModalBg').style.display = 'none';
    }
    document.getElementById('eventModalBg').addEventListener('click', function(e){
      if(e.target === this) closeModal();
    });

    document.getElementById('addEventBtn').onclick = function() {
      requestPasscode('add');
    };

    // --- Passcode modal logic ---
    let pendingAction = null, pendingIdx = null;
    function requestPasscode(action, idx = null) {
      pendingAction = action;
      pendingIdx = idx;
      document.getElementById('passcodeInput').value = '';
      document.getElementById('passcodeError').style.display = 'none';
      document.getElementById('passcodeModalBg').style.display = 'flex';
    }
    function closePasscodeModal() {
      document.getElementById('passcodeModalBg').style.display = 'none';
    }
    document.getElementById('passcodeModalBg').addEventListener('click', function(e){
      if(e.target === this) closePasscodeModal();
    });
    document.getElementById('passcodeForm').onsubmit = function(e) {
      e.preventDefault();
      const pass = document.getElementById('passcodeInput').value.trim();
      if(pass === "autism100") {
        closePasscodeModal();
        if(pendingAction === 'add') openModal(false);
        if(pendingAction === 'edit') openModal(true, pendingIdx);
        if(pendingAction === 'delete') deleteEvent(pendingIdx);
      } else {
        document.getElementById('passcodeError').style.display = 'block';
      }
    }

    // Add/Edit event logic
    document.getElementById('eventForm').onsubmit = function(e) {
      e.preventDefault();
      const idx = document.getElementById('eventIndex').value;
      const date = document.getElementById('eventDate').value.trim().toUpperCase();
      const time = document.getElementById('eventTime').value.trim() || 'NA';
      const title = document.getElementById('eventTitle').value.trim();
      const location = document.getElementById('eventLocation').value.trim();
      let events = getEvents();
      if(idx === '') { // Add new event
        events.push({ date, time, title, location });
      } else { // Edit existing event
        events[idx] = { date, time, title, location };
      }
      setEvents(events);
      renderTimeline();
      closeModal();
    };

    // Delete event with confirmation
    function deleteEvent(idx) {
      if (confirm('Are you sure you want to delete this event?')) {
        let events = getEvents();
        events.splice(idx, 1);
        setEvents(events);
        renderTimeline();
      }
    }

    // --- Initial load + periodic timers ---
    function initialize() {
      renderTimeline();
      renderBigTimer();
      setInterval(renderBigTimer, 1000); // Update clock every second
      // **FIXED**: Check for old events much more frequently.
      setInterval(autodeleteOldEvents, 10000); // Check every 10 seconds
      autodeleteOldEvents(); // Also run once on startup
    }
    
    initialize();

    // For accessibility: close modal on ESC key
    document.addEventListener('keydown', function(e){
      if(e.key === "Escape") {
        closeModal();
        closePasscodeModal();
      }
    });
  </script>
</body>
</html>